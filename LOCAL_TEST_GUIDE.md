# 本地测试指南 - 语音通话功能修复

## 🚀 测试环境准备

### 1. 服务器状态
✅ 本地服务器已启动: `http://localhost:8080`
- 服务器运行在端口 8080
- 可以通过浏览器访问进行测试

### 2. 测试步骤

#### 第一步：基础功能测试
1. **打开浏览器**访问 `http://localhost:8080`
2. **检查页面加载**是否正常
3. **查看控制台**是否有错误信息

#### 第二步：语音通话按钮测试
1. **检查通话按钮**是否可见
   - 在输入框下方应该能看到电话图标按钮
   - 按钮应该显示为蓝色（未通话状态）

2. **测试麦克风权限**
   - 点击测试麦克风按钮
   - 允许浏览器访问麦克风
   - 检查是否显示"麦克风权限正常"

#### 第三步：用户管理测试
1. **首次登录**
   - 输入用户名（如"张三"）
   - 加入房间
   - 检查参与者列表是否显示

2. **重复登录测试**
   - 打开新标签页访问相同地址
   - 使用相同用户名"张三"登录
   - 检查是否还有重复的离线用户

#### 第四步：语音通话功能测试
1. **发起通话**
   - 点击通话按钮
   - 允许麦克风权限
   - 检查是否显示通话面板

2. **通话状态检查**
   - 通话按钮应该变红并显示停止图标
   - 右上角应该显示通话状态指示器
   - 参与者列表应该显示通话状态

#### 第五步：音频功能测试
1. **音频混合器测试**
   - 在浏览器控制台运行：`voiceCallFixTester.runAllTests()`
   - 检查测试结果是否全部通过

2. **WebRTC连接测试**
   - 打开两个浏览器窗口
   - 分别用不同用户名登录
   - 尝试建立语音通话连接

## 🧪 自动化测试

### 运行测试脚本
在浏览器控制台中运行：
```javascript
// 运行所有修复测试
voiceCallFixTester.runAllTests();

// 检查具体功能
console.log('通话按钮:', document.getElementById('callBtn'));
console.log('测试麦克风按钮:', document.getElementById('testMicBtn'));
console.log('AudioMixer类:', typeof AudioMixer);
console.log('WebRTC支持:', typeof RTCPeerConnection);
```

### 测试结果验证
✅ **通过标准**：
- 通话按钮可见且功能正常
- 相同用户名不会产生重复用户
- 音频混合器正常工作
- WebRTC连接建立成功
- 参与者状态同步正确

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 通话按钮不可见
**解决方案**：
- 检查CSS样式是否正确加载
- 确认按钮元素存在：`document.getElementById('callBtn')`
- 检查控制台是否有JavaScript错误

#### 2. 麦克风权限问题
**解决方案**：
- 点击地址栏的麦克风图标
- 选择"允许"访问麦克风
- 刷新页面重新测试

#### 3. 音频没有声音
**解决方案**：
- 检查系统音量设置
- 确认浏览器音频权限
- 测试音频混合器：`new AudioMixer().initialize()`

#### 4. 用户重复问题
**解决方案**：
- 清除浏览器缓存
- 检查localStorage中的用户数据
- 运行清理函数：`cleanupDuplicateOfflineUsers()`

## 📊 测试检查清单

### 基础功能
- [ ] 页面正常加载
- [ ] 用户名设置对话框显示
- [ ] 参与者列表正常显示
- [ ] 聊天功能正常工作

### 语音通话功能
- [ ] 通话按钮可见
- [ ] 测试麦克风按钮功能正常
- [ ] 麦克风权限获取成功
- [ ] 通话发起功能正常
- [ ] 通话状态指示器显示
- [ ] 通话面板正常显示

### 用户管理
- [ ] 用户ID生成稳定
- [ ] 相同用户名不产生重复
- [ ] 离线用户自动清理
- [ ] 参与者状态同步正确

### 音频功能
- [ ] AudioMixer类正常工作
- [ ] WebRTC连接建立成功
- [ ] 音频混合功能正常
- [ ] 音量控制功能正常

## 🎯 测试结果记录

请在测试完成后记录以下信息：

### 测试环境
- 浏览器：_________
- 操作系统：_________
- 设备类型：_________

### 测试结果
- 通话按钮显示：✅/❌
- 用户重复问题：✅/❌
- 音频功能：✅/❌
- 移动端适配：✅/❌

### 发现的问题
1. _________
2. _________
3. _________

### 建议改进
1. _________
2. _________
3. _________

---

**测试时间**: 2024年12月
**测试状态**: 进行中
**修复版本**: v1.0 